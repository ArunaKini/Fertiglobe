{
	"name": "Plain_ReveneuByProduct",
	"properties": {
		"content": {
			"query": "SELECT DISTINCT\n    CAST(CONCAT([Month],'01') AS DATE) AS [KPIDate]\n\t,DATEPART(YEAR,CONCAT([Month],'01')) AS [Year]\n    ,FORMAT(CAST(CONCAT([Month],'01') AS DATE),'MMM') AS [Month]\n\t,[Entity]\t    \n\t,[Product]\t\t\n\t,[Other_Revenue_Details]\n\t,[Trading/Own_Produced]\n\t,[Counterparty]\n\t,[Volume_Type]\n\t,[ValueType]\n\t,[Plan_Year]\n    ,[Volume]\n    ,[Price]\n\t,[Total_Revenue]\nFROM \n(\n--Actual data - Plain\nSELECT DISTINCT\n\tprice.[Month] AS [Month]\t\n\t,price.[Entity] AS [Entity]\n    ,price.[Product] AS [Product] \n\t,price.[Other_Revenue_Details] AS [Other_Revenue_Details]\n\t,price.[Trading/Own_Produced] AS [Trading/Own_Produced]\n\t,price.[Counterparty] AS [Counterparty]\n\t,price.[Volume_Type] AS [Volume_Type]\n\t,'Actual' AS [ValueType]\n\t,NULL AS [Plan_Year]\n    ,SUM([ACT_Revenue_Volumes]) AS [Volume]\n    ,CASE WHEN price.[Entity] = '3004' THEN (SUM([ACT_Revenue_Net_Back_Prices])/SUM(fxRates.[Act_Fx_Loans_Avg])) \n\tELSE SUM([ACT_Revenue_Net_Back_Prices]) END AS [Price]\n\t,CASE WHEN price.[Entity] = '3004' THEN SUM([ACT_Revenue_Volumes])*(SUM([ACT_Revenue_Net_Back_Prices])/SUM(fxRates.[Act_Fx_Loans_Avg])) \n\tELSE SUM([ACT_Revenue_Volumes])*SUM([ACT_Revenue_Net_Back_Prices]) END AS [Total_Revenue]\nFROM [conformed].[Act_Sales_Volume_Price] price\nINNER JOIN [conformed].[Act_Average_Fx_Rates] fxRates \nON price.[Month] = fxRates.[Month]\nWHERE price.[Trading/Own_Produced] = 'OWN' \nAND fxRates.[Functional_Currency] = 'DZD' AND fxRates.[Transactional_Currency] = 'USD'\n--and price.[Month] = 202203 and price.[Entity] = '3004' \nGROUP BY price.[Month], price.[Entity], price.[Product], price.[Other_Revenue_Details]\n\t, price.[Trading/Own_Produced], price.[Counterparty], price.[Volume_Type]\n\nUNION\n--Forecast data - Plain\nSELECT DISTINCT\n\tprice.[Month] AS [Month]\t\n\t,price.[Entity] AS [Entity]\n    ,price.[Product] AS [Product] \n\t,price.[Other_Revenue_Details] AS [Other_Revenue_Details]\n\t,price.[Trading/Own_Produced] AS [Trading/Own_Produced]\n\t,price.[Counterparty] AS [Counterparty]\n\t,price.[Volume_Type] AS [Volume_Type]\n\t,CONCAT('RF',price.[Scenario]) AS [ValueType]\n\t,price.[Plan_Year] AS [Plan_Year]\n    ,SUM([FCT_Revenue_Volumes]) AS [Volume]\n    ,CASE WHEN price.[Entity] = '3004' THEN (SUM([FCT_Revenue_Net_Back_Prices])/SUM(fxRates.[Adm_Fx_Loans_Avg])) \n\tELSE SUM([FCT_Revenue_Net_Back_Prices]) END AS [Price]\n\t,CASE WHEN price.[Entity] = '3004' THEN SUM([FCT_Revenue_Volumes])*(SUM([FCT_Revenue_Net_Back_Prices])/SUM(fxRates.[Adm_Fx_Loans_Avg])) \n\tELSE SUM([FCT_Revenue_Volumes])*SUM([FCT_Revenue_Net_Back_Prices]) END AS [Total_Revenue]\nFROM [conformed].[Fct_Sales_Volume_Price] price\nINNER JOIN [conformed].[Fct_Average_Fx_Rates] fxRates \nON price.[Month] = fxRates.[Month] AND price.[Scenario] = fxRates.[Scenario] AND price.[Version] = fxRates.[Version] AND price.[Plan_Year] = fxRates.[Plan_Year]\nWHERE price.[Version] IN \n(\nSELECT CASE WHEN [Scenario] = 5 THEN 6 ELSE 1 END AS [Version] FROM [conformed].[Fct_Sales_Volume_Price] inr\nWHERE inr.[Month] = price.[Month] AND inr.[Entity] = price.[Entity] AND inr.[Product] = price.[Product] \nAND inr.[Other_Revenue_Details] = price.[Other_Revenue_Details] AND inr.[Scenario] = price.[Scenario] AND inr.[Plan_Year] = price.[Plan_Year]\n)\nAND price.[Plan_Year] = (SELECT DATEPART(YEAR,GETDATE()))\nAND price.[Trading/Own_Produced] = 'OWN' \nAND fxRates.[Functional_Currency] = 'DZD' AND fxRates.[Transactional_Currency] = 'USD'\n--and price.[Month] = 202203 and price.[Entity] = '3004' and price.[Plan_Year] = 2022\nGROUP BY price.[Month],price.[Entity],price.[Product],price.[Other_Revenue_Details],\nprice.[Trading/Own_Produced],price.[Scenario],price.[Plan_Year], price.[Counterparty], price.[Volume_Type]\n\nUNION\n\n--Budget data - Plain\nSELECT DISTINCT\n\tprice.[Month] AS [Month]\t\n\t,price.[Entity] AS [Entity]\n    ,price.[Product] AS [Product] \n\t,price.[Other_Revenue_Details] AS [Other_Revenue_Details]\n\t,price.[Trading/Own_Produced] AS [Trading/Own_Produced]\n\t,price.[Counterparty] AS [Counterparty]\n\t,price.[Volume_Type] AS [Volume_Type]\n\t,'Budget' AS [ValueType]\n\t,price.[Plan_Year] AS [Plan_Year]\n    ,SUM([Budget_Revenue_Volumes]) AS [Volume]\n    ,CASE WHEN price.[Entity] = '3004' THEN (SUM([Budget_Revenue_Net_Back_Prices])/SUM(fxRates.[Adm_Fx_Loans_Avg])) \n\tELSE SUM([Budget_Revenue_Net_Back_Prices]) END AS [Price]\n\t,CASE WHEN price.[Entity] = '3004' THEN SUM([Budget_Revenue_Volumes])*(SUM([Budget_Revenue_Net_Back_Prices])/SUM(fxRates.[Adm_Fx_Loans_Avg])) \n\tELSE SUM([Budget_Revenue_Volumes])*SUM([Budget_Revenue_Net_Back_Prices]) END AS [Total_Revenue]\nFROM [conformed].[Budget_Sales_Volume_Price] price\nINNER JOIN [conformed].[Fct_Average_Fx_Rates] fxRates \nON price.[Month] = fxRates.[Month] AND price.[Scenario] = fxRates.[Scenario] AND price.[Version] = fxRates.[Version] AND price.[Plan_Year] = fxRates.[Plan_Year]\nWHERE price.[Plan_Year] = (SELECT DATEPART(YEAR,GETDATE())-1)\nAND price.[Trading/Own_Produced] = 'OWN' \nAND fxRates.[Functional_Currency] = 'DZD' AND fxRates.[Transactional_Currency] = 'USD'\n--and price.[Month] = 202203 and price.[Entity] = '3004' and price.[Plan_Year] = 2021\nGROUP BY price.[Month],price.[Entity],price.[Product],price.[Other_Revenue_Details],\nprice.[Trading/Own_Produced],price.[Scenario],price.[Plan_Year], price.[Counterparty], price.[Volume_Type]\n\n) subQ1",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "synwsdb01",
				"poolName": "synwsdb01"
			},
			"resultLimit": -1
		},
		"type": "SqlQuery"
	}
}